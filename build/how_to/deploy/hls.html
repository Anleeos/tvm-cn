
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HLS Backend Example &#8212; tvm-cn 1.0.0 文档</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/translations.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="Relay Arm® Compute Library Integration" href="arm_compute_lib.html" />
    <link rel="prev" title="Integrate TVM into Your Project" href="integrate.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="hls-backend-example">
<h1>HLS Backend Example<a class="headerlink" href="#hls-backend-example" title="永久链接至标题">¶</a></h1>
<p>TVM supports Xilinx FPGA board with SDAccel.  Here is a tutorial for how to deploy TVM to AWS F1 FPGA instance.</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>This feature is still experimental.  We cannot use SDAccel to deploy an end to end neural networks for now.</p>
</div>
<p>We use two python scripts for this tutorial.</p>
<ul>
<li><p>build.py - a script to synthesize FPGA bitstream.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tvm</span>
<span class="kn">from</span> <span class="nn">tvm</span> <span class="kn">import</span> <span class="n">te</span>

<span class="n">tgt</span><span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">Target</span><span class="p">(</span><span class="s2">&quot;sdaccel&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;llvm&quot;</span><span class="p">)</span>

<span class="n">n</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">)</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">placeholder</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">placeholder</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">create_schedule</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">op</span><span class="p">)</span>
<span class="n">px</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">C</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nparts</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">s</span><span class="p">[</span><span class="n">C</span><span class="p">]</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">tvm</span><span class="o">.</span><span class="n">te</span><span class="o">.</span><span class="n">thread_axis</span><span class="p">(</span><span class="s2">&quot;pipeline&quot;</span><span class="p">))</span>

<span class="n">fadd</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">],</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;myadd&quot;</span><span class="p">)</span>

<span class="n">fadd</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;myadd.o&quot;</span><span class="p">)</span>
<span class="n">fadd</span><span class="o">.</span><span class="n">imported_modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;myadd.xclbin&quot;</span><span class="p">)</span>

<span class="n">tvm</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">create_shared</span><span class="p">(</span><span class="s2">&quot;myadd.so&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;myadd.o&quot;</span><span class="p">])</span>
</pre></div>
</div>
</li>
<li><p>run.py - a script to use FPGA as an accelerator.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tvm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">tgt</span><span class="o">=</span><span class="s2">&quot;sdaccel&quot;</span>

<span class="n">fadd</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">load_module</span><span class="p">(</span><span class="s2">&quot;myadd.so&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XCL_EMULATION_MODE&quot;</span><span class="p">):</span>
    <span class="n">fadd_dev</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">load_module</span><span class="p">(</span><span class="s2">&quot;myadd.xclbin&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">fadd_dev</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">load_module</span><span class="p">(</span><span class="s2">&quot;myadd.awsxclbin&quot;</span><span class="p">)</span>
<span class="n">fadd</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">fadd_dev</span><span class="p">)</span>

<span class="n">dev</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">),</span> <span class="n">dev</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">),</span> <span class="n">dev</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">tvm</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">),</span> <span class="n">dev</span><span class="p">)</span>

<span class="n">fadd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="n">tvm</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">a</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</li>
</ul>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="永久链接至标题">¶</a></h2>
<ul>
<li><p>Launch an instance using the FPGA Developer AMI.  We don’t need an F1 instance for emulation and synthesis, so it is recommended to use a lower cost instance for them.</p></li>
<li><p>Setup AWS FPGA development kit.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/aws/aws-fpga.git
<span class="nb">cd</span> aws-fpga
<span class="nb">source</span> sdaccel_setup.sh
<span class="nb">source</span> <span class="si">${</span><span class="nv">XILINX_SDX</span><span class="si">}</span>/settings64.sh
</pre></div>
</div>
</li>
<li><p>Setup TVM with OpenCL enabled.</p></li>
</ul>
</div>
<div class="section" id="emulation">
<h2>Emulation<a class="headerlink" href="#emulation" title="永久链接至标题">¶</a></h2>
<ul>
<li><p>Create emconfig.json for emulation.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>emconfigutil --platform <span class="si">${</span><span class="nv">AWS_PLATFORM</span><span class="si">}</span> --nd <span class="m">1</span>
</pre></div>
</div>
</li>
<li><p>Copy emconfig.json to the python binary directory.  It is because the current Xilinx toolkit assumes that both host binary and the emconfig.json file are in the same path.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cp emconfig.json <span class="k">$(</span>dirname <span class="k">$(</span>which python<span class="k">))</span>
</pre></div>
</div>
</li>
<li><p>Run software emulation</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">XCL_EMULATION_MODE</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span> <span class="nv">XCL_TARGET</span><span class="o">=</span>sw_emu

python build.py
python run.py
</pre></div>
</div>
</li>
<li><p>Run hardware emulation</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">XCL_EMULATION_MODE</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span> <span class="nv">XCL_TARGET</span><span class="o">=</span>hw_emu

python build.py
python run.py
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="synthesis">
<h2>Synthesis<a class="headerlink" href="#synthesis" title="永久链接至标题">¶</a></h2>
<ul>
<li><p>Run synthesis with the following script.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">unset</span> XCL_EMULATION_MODE
<span class="nb">export</span> <span class="nv">XCL_TARGET</span><span class="o">=</span>hw

python build.py
</pre></div>
</div>
</li>
<li><p>Create AWS FPGA image and upload it to AWS S3.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="si">${</span><span class="nv">SDACCEL_DIR</span><span class="si">}</span>/tools/create_sdaccel_afi.sh <span class="se">\</span>
    -xclbin<span class="o">=</span>myadd.xclbin -o<span class="o">=</span>myadd <span class="se">\</span>
    -s3_bucket<span class="o">=</span>&lt;bucket-name&gt; -s3_dcp_key<span class="o">=</span>&lt;dcp-folder-name&gt; <span class="se">\</span>
    -s3_logs_key<span class="o">=</span>&lt;logs-folder-name&gt;
</pre></div>
</div>
<p>This also generates an awsxclbin file, which is necessary to use the AWS FPGA image on F1 instances.</p>
</li>
</ul>
</div>
<div class="section" id="run">
<h2>Run<a class="headerlink" href="#run" title="永久链接至标题">¶</a></h2>
<ul>
<li><p>Launch Amazon EC2 F1 instance.</p></li>
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">myadd.so</span></code>, <code class="docutils literal notranslate"><span class="pre">myadd.awsxclbin</span></code>, and <code class="docutils literal notranslate"><span class="pre">run.py</span></code> to the F1 instance.</p></li>
<li><p>Setup AWS FPGA development kit.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/aws/aws-fpga.git
<span class="nb">cd</span> aws-fpga
<span class="nb">source</span> sdaccel_setup.sh
</pre></div>
</div>
</li>
<li><p>Setup TVM with OpenCL enabled.</p></li>
<li><p>Become root and setup environment variables.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo sh
<span class="nb">source</span> <span class="si">${</span><span class="nv">INSTALL_ROOT</span><span class="si">}</span>/setup.sh
</pre></div>
</div>
</li>
<li><p>Run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python run.py
</pre></div>
</div>
</li>
</ul>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">tvm-cn</a></h1>








<h3>导航</h3>
<p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install/index.html">安装 TVM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/index.html">Contributor Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">How To Guides</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../dev/tutorial/index.html">Developer Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/how_to/how_to.html">Developer How-To Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">Architecture Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">Design and Architecture</a></li>
</ul>
<p class="caption"><span class="caption-text">Topic Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../topic/microtvm/index.html">microTVM: TVM on bare-metal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../topic/vta/index.html">VTA: Versatile Tensor Accelerator</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">How To Guides</a><ul>
  <li><a href="index.html">Deploy Models and Integrate TVM</a><ul>
      <li>Previous: <a href="integrate.html" title="上一章">Integrate TVM into Your Project</a></li>
      <li>Next: <a href="arm_compute_lib.html" title="下一章">Relay Arm<sup>®</sup> Compute Library Integration</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="转向" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, HyperAI.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/how_to/deploy/hls.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>